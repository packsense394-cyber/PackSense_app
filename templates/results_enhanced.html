<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PackSense - Detailed Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(1deg); }
            66% { transform: translateY(10px) rotate(-1deg); }
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 1.8em;
            font-weight: 700;
        }
        
        .logo-icon {
            background: linear-gradient(45deg, #fff, #e8f1fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-right: 10px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* Main layout with sidebar */
        .main-layout {
            display: flex;
            margin-top: 80px;
            min-height: calc(100vh - 80px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 80px;
            height: calc(100vh - 80px);
            z-index: 999;
        }
        
        /* Main content area */
        .main-content {
            flex: 1;
            margin-left: 350px;
            padding: 30px;
            overflow-y: auto;
        }
        
        /* Sidebar sections */
        .sidebar-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-section h3 {
            color: #1e3c72;
            font-size: 1.2em;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Review filters */
        .review-filter {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-weight: 500;
        }
        
        .review-filter:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .review-filter.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }
        
        .filter-count {
            float: right;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        
        /* Filter controls */
        .filter-control {
            margin-bottom: 15px;
        }
        
        .filter-control label {
            display: block;
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .filter-control select,
        .filter-control input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            background: white;
        }
        
        /* Action buttons */
        .action-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Metrics cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .metric-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            display: block;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 8px;
        }
        
        .metric-label {
            font-size: 1em;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Enhanced analysis info */
        .enhanced-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .enhanced-info h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .enhanced-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        
        .enhanced-stat {
            text-align: center;
        }
        
        .enhanced-stat strong {
            display: block;
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        
        /* Reviews section */
        .reviews-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .reviews-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .reviews-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #1e3c72;
        }
        
        .reviews-count {
            color: #666;
            font-size: 0.9em;
        }
        
        /* Review cards */
        .review-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .review-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .reviewer-info {
            flex: 1;
            min-width: 200px;
        }
        
        .reviewer-name {
            font-weight: 600;
            color: #1e3c72;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .review-title {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
            margin-bottom: 5px;
        }
        
        .review-rating {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stars {
            color: #ffd700;
        }
        
        .review-date {
            color: #666;
            font-size: 0.9em;
        }
        
        .review-text {
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
        }
        
        .review-images {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .review-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .review-image:hover {
            transform: scale(1.1);
        }
        
        .packaging-badge {
            display: inline-block;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 10px;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .main-layout {
                flex-direction: column;
            }
        }
        
        /* Loading animation */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Chatbot styles */
        .chatbot-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        
        .chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .chatbot-modal {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 400px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chatbot-header h3 {
            margin: 0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chatbot-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }
        
        .chatbot-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
        }
        
        .user-message {
            justify-content: flex-end;
        }
        
        .bot-message {
            justify-content: flex-start;
        }
        
        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .user-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .bot-message .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }
        
        .chatbot-input {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        .chatbot-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .chatbot-input button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chatbot-input button:hover {
            transform: scale(1.05);
        }
        
        /* Pagination styles */
        .pagination-container {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .pagination-info {
            text-align: center;
            margin-bottom: 15px;
            color: #1e3c72;
            font-weight: 600;
        }
        
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .pagination-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pagination-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .page-numbers {
            display: flex;
            gap: 5px;
        }
        
        .page-number {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .page-number:hover {
            background: #667eea;
            color: white;
        }
        
        .page-number.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-color: #4facfe;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <div class="logo-icon">⬡</div>
            PackSense
        </div>
        <div class="nav-links">
            <a href="/" class="nav-link">Home</a>
            <a href="/" class="nav-link">+ New Analysis</a>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Product Info -->
            <div class="sidebar-section">
                <h3><i class="fas fa-box"></i> Product Info</h3>
                <p><strong>{{ product_name }}</strong></p>
                <a href="{{ product_description_url }}" class="action-btn btn-success">
                    <i class="fas fa-info-circle"></i> View Product Page
                </a>
            </div>

            <!-- Review Filters -->
            <div class="sidebar-section">
                <h3><i class="fas fa-filter"></i> Review Filters</h3>
                <button class="review-filter active" data-filter="all">
                    All Reviews <span class="filter-count">{{ review_filters.all_reviews }}</span>
                </button>
                <button class="review-filter" data-filter="packaging">
                    Packaging Related <span class="filter-count">{{ review_filters.packaging_reviews }}</span>
                </button>
                <button class="review-filter" data-filter="positive">
                    Positive <span class="filter-count">{{ review_filters.positive_reviews }}</span>
                </button>
                <button class="review-filter" data-filter="neutral">
                    Neutral <span class="filter-count">{{ review_filters.neutral_reviews }}</span>
                </button>
                <button class="review-filter" data-filter="negative">
                    Negative <span class="filter-count">{{ review_filters.negative_reviews }}</span>
                </button>
            </div>

            <!-- Analysis Controls -->
            <div class="sidebar-section">
                <h3><i class="fas fa-cogs"></i> Analysis Controls</h3>
                
                <div class="filter-control">
                    <label>Packaging Keyword Frequencies:</label>
                    <select id="keyword-freq-select">
                        <option value="">-- Select a keyword to view frequency --</option>
                        {% for keyword, freq in packaging_freq.items() %}
                        <option value="{{ keyword }}">{{ keyword }} ({{ freq }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-control">
                    <label>Filter by Keywords:</label>
                    <input type="text" id="keyword-filter" placeholder="Enter keyword...">
                </div>

                <div class="filter-control">
                    <label>Filter by Packaging Terms:</label>
                    <select id="packaging-filter">
                        <option value="">-- Select packaging term --</option>
                        {% for term in packaging_dropdown_data %}
                        <option value="{{ term }}">{{ term }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button class="action-btn btn-primary" onclick="showCooccurrenceNetwork()">
                    <i class="fas fa-project-diagram"></i> Co-occurrence Network
                </button>
                
                <button class="action-btn btn-warning" onclick="markDefectiveParts()">
                    <i class="fas fa-exclamation-triangle"></i> Mark Defective Parts
                </button>
                
                <button class="action-btn btn-success" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> Reset Filters
                </button>
                

            </div>

            <!-- Downloads -->
            <div class="sidebar-section">
                <h3><i class="fas fa-download"></i> Downloads</h3>
                <a href="{{ excel_file }}" class="action-btn btn-primary">
                    <i class="fas fa-file-excel"></i> Download Excel Report
                </a>
                <a href="{{ packaging_library_url }}" class="action-btn btn-success">
                    <i class="fas fa-book"></i> Packaging Library
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Metrics Grid -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <span class="metric-icon">📦</span>
                    <div class="metric-value">{{ total_reviews }}</div>
                    <div class="metric-label">Total Reviews</div>
                </div>

                {% if enhanced_metrics.has_enhanced_data %}
                <div class="metric-card">
                    <span class="metric-icon">🔍</span>
                    <div class="metric-value">{{ enhanced_metrics.packaging_related }}</div>
                    <div class="metric-label">Packaging Related</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        {{ "%.1f"|format(enhanced_metrics.packaging_percentage) }}% of total
                    </div>
                </div>
                {% endif %}

                <div class="metric-card">
                    <span class="metric-icon">😊</span>
                    <div class="metric-value">{{ positive_count }}</div>
                    <div class="metric-label">Positive Reviews</div>
                </div>

                <div class="metric-card">
                    <span class="metric-icon">😐</span>
                    <div class="metric-value">{{ neutral_count }}</div>
                    <div class="metric-label">Neutral Reviews</div>
                </div>

                <div class="metric-card">
                    <span class="metric-icon">😞</span>
                    <div class="metric-value">{{ negative_count }}</div>
                    <div class="metric-label">Negative Reviews</div>
                </div>

                <div class="metric-card">
                    <span class="metric-icon">❌</span>
                    <div class="metric-value">{{ defect_pairs|length }}</div>
                    <div class="metric-label">Defects Detected</div>
                </div>
            </div>

            <!-- Enhanced Analysis Info -->
            {% if enhanced_metrics.has_enhanced_data %}
            <div class="enhanced-info">
                <h3><i class="fas fa-rocket"></i> Enhanced Recursive Analysis</h3>
                <p>This analysis used the Recursive Review Extraction Strategy to provide comprehensive packaging insights.</p>
                <div class="enhanced-stats">
                    <div class="enhanced-stat">
                        <strong>Initial Reviews</strong>
                        <span>{{ enhanced_metrics.total_reviews - enhanced_metrics.packaging_related }}</span>
                    </div>
                    <div class="enhanced-stat">
                        <strong>Packaging Reviews</strong>
                        <span>{{ enhanced_metrics.packaging_related }}</span>
                    </div>
                    <div class="enhanced-stat">
                        <strong>Packaging Coverage</strong>
                        <span>{{ "%.1f"|format(enhanced_metrics.packaging_percentage) }}%</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Reviews Section -->
            <div class="reviews-section">
                <div class="reviews-header">
                    <div>
                        <div class="reviews-title">Product Reviews</div>
                        <div class="reviews-count">Showing <span id="visible-count">{{ reviews|length }}</span> of {{ reviews|length }} reviews</div>
                    </div>
                </div>

                <div id="reviews-container">
                    {% for review in reviews %}
                    <div class="review-card" data-sentiment="{{ review.sentiment if review.sentiment else 'neutral' }}" data-packaging="{{ 'true' if review.is_packaging_related else 'false' }}" data-rating="{{ review.rating or 0 }}" data-initial-display="{% if loop.index <= 10 %}block{% else %}none{% endif %}">
                        <div class="review-header">
                            <div class="reviewer-info">
                                <div class="reviewer-name">{{ review.reviewer_name or 'Anonymous' }}</div>
                                {% if review.review_title %}
                                <div class="review-title">{{ review.review_title }}</div>
                                {% endif %}
                            </div>
                            <div class="review-rating">
                                <div class="stars">
                                    {% set rating = 0 %}
                                    {% if review.rating %}
                                        {% if review.rating is string %}
                                            {% set rating = review.rating|replace('.', '')|replace('-', '')|replace('+', '')|int %}
                                        {% else %}
                                            {% set rating = review.rating|int %}
                                        {% endif %}
                                    {% endif %}
                                    {% for i in range(5) %}
                                        {% if i < rating %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <span style="margin-left: 10px; font-weight: 600;">{{ review.rating or 'N/A' }}/5</span>
                            </div>
                            <div class="review-date">{{ review.review_date or 'Date not available' }}</div>
                        </div>
                        
                        <div class="review-text">{{ review.review_text or 'No review text available' }}</div>
                        
                        {% if review.is_packaging_related %}
                        <div class="packaging-badge">
                            <i class="fas fa-box"></i> Packaging Related
                        </div>
                        {% endif %}
                        
                        {% if review.review_images %}
                        <div class="review-images">
                            {% for img_url in review.review_images %}
                            <img src="{{ img_url }}" alt="Review image" class="review-image" onclick="openImageModal('{{ img_url }}')">
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        Showing <span id="current-page-info">1-10</span> of {{ reviews|length }} reviews
                    </div>
                    <div class="pagination-controls">
                        <button id="prev-page" class="pagination-btn" onclick="changePage(-1)" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <div class="page-numbers" id="page-numbers">
                            <!-- Page numbers will be generated by JavaScript -->
                        </div>
                        <button id="next-page" class="pagination-btn" onclick="changePage(1)">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing...</p>
    </div>

    <!-- Chatbot -->
    <div class="chatbot-container">
        <button class="chatbot-toggle" onclick="toggleChatbot()">
            <i class="fas fa-comments"></i>
        </button>
        
        <div class="chatbot-modal" id="chatbot-modal">
            <div class="chatbot-header">
                <h3><i class="fas fa-robot"></i> PackSense Assistant</h3>
                <button class="chatbot-close" onclick="toggleChatbot()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="chatbot-messages" id="chatbot-messages">
                <div class="message bot-message">
                    <div class="message-content">
                        Hi! I'm your PackSense review assistant. 👋<br>
                        You can ask me to:<br>
                        • Summarize reviews<br>
                        • Extract packaging keywords<br>
                        • Sentiment summary<br>
                        • Common packaging issues<br>
                        • Show reviews about [keyword]<br>
                        • Show sentiment chart<br>
                        • Show wordcloud<br>
                        Type "help" for more commands!
                    </div>
                </div>
            </div>
            
            <div class="chatbot-input">
                <input type="text" id="chatbot-input" placeholder="Ask me about the reviews..." onkeypress="handleChatbotKeypress(event)">
                <button onclick="sendChatbotMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>

        
        // Global variables for pagination and filtering
        let currentPage = 1;
        let currentFilter = 'all';
        let filteredReviews = [];
        const reviewsPerPage = 10;
        
        // Review filtering functionality
        document.addEventListener('DOMContentLoaded', function() {
            const filterButtons = document.querySelectorAll('.review-filter');
            const reviewCards = document.querySelectorAll('.review-card');
            const visibleCount = document.getElementById('visible-count');
            
            // Initialize with all reviews
            filteredReviews = Array.from(reviewCards);
            updateVisibleCount();
            showCurrentPageReviews();
            updatePagination();
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    currentFilter = filter;
                    currentPage = 1; // Reset to first page when filtering
                    
                    // Filter reviews based on selection
                    filteredReviews = Array.from(reviewCards).filter(card => {
                        switch(filter) {
                            case 'all':
                                return true;
                            case 'packaging':
                                return card.getAttribute('data-packaging') === 'true';
                            case 'positive':
                                return card.getAttribute('data-sentiment') === 'positive';
                            case 'neutral':
                                return card.getAttribute('data-sentiment') === 'neutral';
                            case 'negative':
                                return card.getAttribute('data-sentiment') === 'negative';
                            default:
                                return true;
                        }
                    });
                    
                    updateVisibleCount();
                    showCurrentPageReviews();
                    updatePagination();
                });
            });
        });
        
        // Update visible count
        function updateVisibleCount() {
            document.getElementById('visible-count').textContent = filteredReviews.length;
        }

        // Keyword filtering
        document.getElementById('keyword-filter').addEventListener('input', function() {
            const keyword = this.value.toLowerCase();
            const allReviewCards = document.querySelectorAll('.review-card');
            
            // Apply keyword filter to the current filtered reviews
            filteredReviews = Array.from(allReviewCards).filter(card => {
                const text = card.querySelector('.review-text').textContent.toLowerCase();
                return text.includes(keyword);
            });
            
            currentPage = 1; // Reset to first page
            updateVisibleCount();
            showCurrentPageReviews();
            updatePagination();
        });

        // Packaging term filtering
        document.getElementById('packaging-filter').addEventListener('change', function() {
            const term = this.value.toLowerCase();
            const allReviewCards = document.querySelectorAll('.review-card');
            
            if (!term) {
                // If no term selected, show all reviews based on current filter
                filteredReviews = Array.from(allReviewCards).filter(card => {
                    switch(currentFilter) {
                        case 'all':
                            return true;
                        case 'packaging':
                            return card.getAttribute('data-packaging') === 'true';
                        case 'positive':
                            return card.getAttribute('data-sentiment') === 'positive';
                        case 'neutral':
                            return card.getAttribute('data-sentiment') === 'neutral';
                        case 'negative':
                            return card.getAttribute('data-sentiment') === 'negative';
                        default:
                            return true;
                    }
                });
            } else {
                // Apply packaging term filter to the current filtered reviews
                filteredReviews = Array.from(allReviewCards).filter(card => {
                    const text = card.querySelector('.review-text').textContent.toLowerCase();
                    return text.includes(term);
                });
            }
            
            currentPage = 1; // Reset to first page
            updateVisibleCount();
            showCurrentPageReviews();
            updatePagination();
        });

        // Reset filters
        function resetFilters() {
            document.getElementById('keyword-filter').value = '';
            document.getElementById('packaging-filter').value = '';
            document.getElementById('keyword-freq-select').value = '';
            
            // Reset to all reviews
            const allReviewCards = document.querySelectorAll('.review-card');
            filteredReviews = Array.from(allReviewCards);
            currentFilter = 'all';
            currentPage = 1;
            
            // Reset filter buttons
            document.querySelectorAll('.review-filter').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-filter="all"]').classList.add('active');
            
            updateVisibleCount();
            showCurrentPageReviews();
            updatePagination();
        }

        // Co-occurrence network
        function showCooccurrenceNetwork() {
            console.log('showCooccurrenceNetwork function called!');
            
            // Get co-occurrence data
            let cooccurrenceData = {};
            try {
                console.log('Raw co-occurrence data:', '{{ cooccurrence_data|tojson|safe }}');
                const parsedData = JSON.parse('{{ cooccurrence_data|tojson|safe }}');
                console.log('Parsed co-occurrence data:', parsedData);
                
                if (parsedData && Object.keys(parsedData).length > 0) {
                    cooccurrenceData = parsedData;
                } else {
                    // Use sample data if no real data
                    cooccurrenceData = {
                        "packaging": {"pack": 58, "container": 45, "bottle": 23},
                        "pack": {"packaging": 58, "bottle": 23, "leak": 12},
                        "container": {"packaging": 45, "leak": 12, "damage": 8},
                        "bottle": {"packaging": 23, "pack": 23, "leak": 15},
                        "leak": {"pack": 12, "container": 12, "bottle": 15}
                    };
                }
            } catch (error) {
                console.error('Error parsing co-occurrence data:', error);
                console.log('Using sample data instead');
                cooccurrenceData = {
                    "packaging": {"pack": 58, "container": 45, "bottle": 23},
                    "pack": {"packaging": 58, "bottle": 23, "leak": 12},
                    "container": {"packaging": 45, "leak": 12, "damage": 8},
                    "bottle": {"packaging": 23, "pack": 23, "leak": 15},
                    "leak": {"pack": 12, "container": 12, "bottle": 15}
                };
            }
            
            // Create modal for interactive network visualization
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                width: 95vw;
                height: 95vh;
                overflow: hidden;
                position: relative;
                display: flex;
                flex-direction: column;
            `;
            
            // Close button
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = `
                position: absolute;
                top: 15px;
                right: 20px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
                z-index: 1001;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);
            
            // Title with reset button
            const titleContainer = document.createElement('div');
            titleContainer.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 0 0 20px 0;
            `;
            
            const title = document.createElement('h2');
            title.textContent = 'Interactive Co-occurrence Network';
            title.style.cssText = `
                margin: 0;
                color: #333;
                font-size: 1.5em;
            `;
            
            const resetButton = document.createElement('button');
            resetButton.textContent = 'Reset View';
            resetButton.style.cssText = `
                padding: 8px 16px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.9em;
            `;
            resetButton.onclick = function() {
                // Reset all nodes and links to normal
                node.attr('opacity', 1);
                link.attr('stroke-opacity', 0.6).attr('stroke-width', d => Math.sqrt(d.weight) * 2);
                infoPanel.style.display = 'none';
            };
            
            titleContainer.appendChild(title);
            titleContainer.appendChild(resetButton);
            
            // Network container with integrated layout
            const networkContainer = document.createElement('div');
            networkContainer.id = 'network-container';
            networkContainer.style.cssText = `
                flex: 1;
                min-height: 600px;
                background: #f8f9fa;
                border-radius: 10px;
                position: relative;
                overflow: hidden;
                display: flex;
            `;
            
            // SVG container for network
            const svgContainer = document.createElement('div');
            svgContainer.id = 'svg-container';
            svgContainer.style.cssText = `
                flex: 2;
                position: relative;
                overflow: hidden;
            `;
            
            // Info panel integrated into the layout
            const infoPanel = document.createElement('div');
            infoPanel.id = 'info-panel';
            infoPanel.style.cssText = `
                flex: 1;
                background: white;
                border-left: 2px solid #eee;
                padding: 25px;
                max-height: 100%;
                overflow-y: auto;
                display: none;
                box-shadow: -4px 0 15px rgba(0,0,0,0.1);
            `;
            
            networkContainer.appendChild(svgContainer);
            networkContainer.appendChild(infoPanel);
            
            modalContent.appendChild(closeBtn);
            modalContent.appendChild(titleContainer);
            modalContent.appendChild(networkContainer);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Create interactive network visualization
            console.log('About to create network visualization...');
            console.log('Container:', networkContainer);
            console.log('Info panel:', infoPanel);
            
            try {
                createInteractiveNetwork(cooccurrenceData, networkContainer, infoPanel);
            } catch (error) {
                console.error('Error creating D3.js visualization:', error);
                console.log('Falling back to simple visualization...');
                createFallbackVisualization(cooccurrenceData, networkContainer, infoPanel);
            }
        }
        
        // Create interactive network visualization
        function createInteractiveNetwork(data, container, infoPanel) {
            console.log('Creating interactive network with data:', data);
            
            // Get the SVG container
            const svgContainer = container.querySelector('#svg-container');
            if (!svgContainer) {
                console.error('SVG container not found!');
                return;
            }
            
            // Clear SVG container
            svgContainer.innerHTML = '';
            
            // Check if D3.js is available
            if (typeof d3 === 'undefined') {
                console.error('D3.js is not loaded!');
                svgContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <h3>D3.js Library Error</h3>
                        <p>D3.js library failed to load. Please refresh the page and try again.</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Refresh Page
                        </button>
                    </div>
                `;
                return;
            }
            
            // Process data for network visualization
            const nodes = [];
            const links = [];
            const nodeMap = new Map();
            
            // Create nodes
            let nodeId = 0;
            for (const [term, connections] of Object.entries(data)) {
                if (!nodeMap.has(term)) {
                    nodeMap.set(term, nodeId++);
                    nodes.push({
                        id: term,
                        name: term,
                        connections: Object.keys(connections).length,
                        totalWeight: Object.values(connections).reduce((a, b) => a + b, 0)
                    });
                }
                
                for (const [targetTerm, weight] of Object.entries(connections)) {
                    if (!nodeMap.has(targetTerm)) {
                        nodeMap.set(targetTerm, nodeId++);
                        nodes.push({
                            id: targetTerm,
                            name: targetTerm,
                            connections: 0,
                            totalWeight: 0
                        });
                    }
                    
                    links.push({
                        source: term,
                        target: targetTerm,
                        weight: weight
                    });
                }
            }
            
            // Update connection counts
            links.forEach(link => {
                const sourceNode = nodes.find(n => n.id === link.source);
                const targetNode = nodes.find(n => n.id === link.target);
                if (sourceNode) sourceNode.connections++;
                if (targetNode) targetNode.connections++;
            });
            
            console.log('Processed nodes:', nodes);
            console.log('Processed links:', links);
            
            if (nodes.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <h3>No Data Available</h3>
                        <p>No co-occurrence data found. Please try analyzing a different product.</p>
                    </div>
                `;
                return;
            }
            
            // Create SVG for network visualization
            const svg = d3.select(svgContainer)
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .style('background', '#f8f9fa')
                .style('border-radius', '10px');
            
            // Get container dimensions
            const width = svgContainer.clientWidth || 800;
            const height = svgContainer.clientHeight || 600;
            
            console.log('Container dimensions:', width, height);
            
            // Create force simulation with better parameters
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(150))
                .force('charge', d3.forceManyBody().strength(-500))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(60))
                .force('x', d3.forceX(width / 2).strength(0.1))
                .force('y', d3.forceY(height / 2).strength(0.1));
            
            // Create links
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.6)
                .attr('stroke-width', d => Math.sqrt(d.weight) * 2);
            
            // Create nodes with better interaction
            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter().append('circle')
                .attr('r', d => Math.max(25, Math.sqrt(d.connections) * 10))
                .attr('fill', d => getNodeColor(d.connections))
                .attr('stroke', '#fff')
                .attr('stroke-width', 3)
                .style('cursor', 'pointer')
                .style('transition', 'all 0.3s ease')
                .on('mouseover', function(event, d) {
                    console.log('Mouse over node:', d.name);
                    
                    // Enlarge the node
                    d3.select(this).attr('r', d => Math.max(35, Math.sqrt(d.connections) * 12));
                    
                    // Highlight connected links
                    link.attr('stroke-opacity', l => 
                        l.source.id === d.id || l.target.id === d.id ? 1 : 0.1
                    ).attr('stroke-width', l => 
                        l.source.id === d.id || l.target.id === d.id ? 4 : 2
                    );
                    
                    // Highlight connected nodes
                    node.attr('opacity', n => 
                        n.id === d.id || links.some(l => 
                            (l.source.id === d.id && l.target.id === n.id) ||
                            (l.target.id === d.id && l.source.id === n.id)
                        ) ? 1 : 0.3
                    );
                })
                .on('mouseout', function(event, d) {
                    console.log('Mouse out node:', d.name);
                    
                    // Reset node size
                    d3.select(this).attr('r', d => Math.max(25, Math.sqrt(d.connections) * 10));
                    
                    // Reset link opacity and width
                    link.attr('stroke-opacity', 0.6).attr('stroke-width', d => Math.sqrt(d.weight) * 2);
                    
                    // Reset node opacity
                    node.attr('opacity', 1);
                })
                .on('click', function(event, d) {
                    console.log('Clicked node:', d.name);
                    event.stopPropagation();
                    
                    // Show detailed information and make info panel visible
                    showNodeDetails(d, infoPanel);
                    infoPanel.style.display = 'block';
                    
                    // Highlight selected node and blur others
                    node.attr('opacity', n => n.id === d.id ? 1 : 0.2);
                    link.attr('stroke-opacity', l => 
                        l.source.id === d.id || l.target.id === d.id ? 1 : 0.1
                    );
                });
            
            // Add node labels with better styling
            const label = svg.append('g')
                .selectAll('text')
                .data(nodes)
                .enter().append('text')
                .text(d => d.name)
                .attr('text-anchor', 'middle')
                .attr('dy', '.35em')
                .attr('font-size', '14px')
                .attr('font-weight', 'bold')
                .attr('fill', '#333')
                .style('pointer-events', 'none')
                .style('text-shadow', '1px 1px 2px rgba(255,255,255,0.8)')
                .style('font-family', 'Inter, sans-serif');
            
            // Set initial positions to spread nodes out
            nodes.forEach((node, i) => {
                const angle = (i / nodes.length) * 2 * Math.PI;
                const radius = Math.min(width, height) * 0.3;
                node.x = width / 2 + radius * Math.cos(angle);
                node.y = height / 2 + radius * Math.sin(angle);
            });
            
            // Update positions on simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            // Add drag behavior
            node.call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));
            
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            console.log('D3.js network visualization created successfully');
        }
        
        // Fallback visualization if D3.js fails
        function createFallbackVisualization(data, container, infoPanel) {
            console.log('Creating fallback visualization...');
            
            container.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h3 style="color: #333; margin-bottom: 20px;">Co-occurrence Network</h3>
                    <p style="color: #666; margin-bottom: 30px;">Interactive network visualization is loading...</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        ${Object.entries(data).map(([term, connections]) => `
                            <div style="background: linear-gradient(135deg, ${getNodeColor(Object.keys(connections).length)} 0%, ${getNodeColor(Object.keys(connections).length)}dd 100%); 
                                        color: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer;"
                                 onclick="showNodeDetails({id: '${term}', name: '${term}', connections: ${Object.keys(connections).length}, totalWeight: ${Object.values(connections).reduce((a, b) => a + b, 0)}}, document.getElementById('info-panel'))">
                                <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">${term}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">${Object.keys(connections).length} connections</div>
                                <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">Weight: ${Object.values(connections).reduce((a, b) => a + b, 0)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Get node color based on connections
        function getNodeColor(connections) {
            if (connections > 10) return '#ff6b6b';
            if (connections > 5) return '#4ecdc4';
            if (connections > 2) return '#45b7d1';
            return '#96ceb4';
        }
        
        // Show node information on hover
        function showNodeInfo(node, infoPanel) {
            infoPanel.innerHTML = `
                <h4 style="margin: 0 0 10px 0; color: #333;">${node.name}</h4>
                <p style="margin: 5px 0; color: #666;">
                    <strong>Connections:</strong> ${node.connections}
                </p>
                <p style="margin: 5px 0; color: #666;">
                    <strong>Total Weight:</strong> ${node.totalWeight}
                </p>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #999;">
                    Click for more details
                </p>
            `;
            infoPanel.style.display = 'block';
        }
        
        // Show detailed node information on click
        function showNodeDetails(node, infoPanel) {
            // Get related reviews and images
            const reviews = JSON.parse('{{ reviews|tojson|safe }}');
            const relatedReviews = reviews.filter(review => 
                review.review_text && review.review_text.toLowerCase().includes(node.name.toLowerCase())
            );
            
            // Get related images
            const relatedImages = [];
            reviews.forEach(review => {
                if (review.review_images && review.review_images.length > 0) {
                    review.review_images.forEach(img => {
                        if (img.toLowerCase().includes(node.name.toLowerCase()) || 
                            review.review_text.toLowerCase().includes(node.name.toLowerCase())) {
                            relatedImages.push({
                                url: img,
                                reviewer: review.reviewer_name || 'Anonymous',
                                review_text: review.review_text.substring(0, 50) + '...'
                            });
                        }
                    });
                }
            });
            
            let content = `
                <div style="height: 100%; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; color: #333; text-align: center; padding-bottom: 15px; border-bottom: 2px solid #667eea;">${node.name.toUpperCase()}</h3>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 5px 0; color: #666;">
                            <strong>Connections:</strong> ${node.connections}
                        </p>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>Total Weight:</strong> ${node.totalWeight}
                        </p>
                    </div>
                    
                    <h4 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center;">
                        <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-right: 8px;">${relatedReviews.length}</span>
                        Related Sentences
                    </h4>
            `;
            
            if (relatedReviews.length > 0) {
                relatedReviews.slice(0, 5).forEach((review, index) => {
                    const reviewText = review.review_text.substring(0, 150) + '...';
                    content += `
                        <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                            <p style="margin: 0 0 8px 0; font-size: 0.9em; color: #333; line-height: 1.4;">${reviewText}</p>
                            <p style="margin: 0; font-size: 0.8em; color: #666;">
                                <strong>By:</strong> ${review.reviewer_name || 'Anonymous'}
                                ${review.review_date ? `<br><strong>Date:</strong> ${review.review_date}` : ''}
                            </p>
                        </div>
                    `;
                });
                
                if (relatedReviews.length > 5) {
                    content += `<p style="font-size: 0.8em; color: #999; text-align: center; margin: 10px 0;">... and ${relatedReviews.length - 5} more reviews</p>`;
                }
            } else {
                content += `<p style="font-size: 0.9em; color: #999; font-style: italic;">No related sentences found</p>`;
            }
            
            // Add related images section
            content += `
                <h4 style="margin: 30px 0 15px 0; color: #333; display: flex; align-items: center;">
                    <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-right: 8px;">${relatedImages.length}</span>
                    Related Images
                </h4>
            `;
            
            if (relatedImages.length > 0) {
                content += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">`;
                
                relatedImages.slice(0, 6).forEach((imgData, index) => {
                    content += `
                        <div style="text-align: center;">
                            <img src="${imgData.url}" alt="Related image" 
                                 style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #eee; cursor: pointer;"
                                 onclick="openImageModal('${imgData.url}', '${imgData.reviewer}', '${imgData.review_text.replace(/'/g, "\\'")}')"
                                 onerror="this.style.display='none'">
                            <p style="font-size: 0.7em; color: #666; margin: 5px 0 0 0;">${imgData.reviewer}</p>
                        </div>
                    `;
                });
                
                content += `</div>`;
                
                if (relatedImages.length > 6) {
                    content += `<p style="font-size: 0.8em; color: #999; text-align: center; margin: 10px 0;">... and ${relatedImages.length - 6} more images</p>`;
                }
            } else {
                content += `<p style="font-size: 0.9em; color: #999; font-style: italic;">No related images found</p>`;
            }
            
            content += `</div>`;
            
            infoPanel.innerHTML = content;
            infoPanel.style.display = 'block';
        }
        
        // Function to open image modal
        function openImageModal(imageUrl, reviewer, reviewText) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 20000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 20px;
                max-width: 90%;
                max-height: 90%;
                text-align: center;
            `;
            
            modalContent.innerHTML = `
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                <h4 style="margin: 0 0 15px 0; color: #333;">Related Image</h4>
                <img src="${imageUrl}" alt="Review image" style="max-width: 100%; max-height: 60vh; border-radius: 8px;">
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;"><strong>By:</strong> ${reviewer}</p>
                <p style="margin: 5px 0 0 0; font-size: 0.8em; color: #999;">${reviewText}</p>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // Mark defective parts
        function markDefectiveParts() {
            console.log('markDefectiveParts function called!');
            
            // Test with sample data first
            let defectPairs = [
                ["package", "leak"],
                ["container", "damage"],
                ["bottle", "broken"],
                ["cap", "loose"],
                ["seal", "crack"]
            ];
            
            try {
                console.log('Raw defect pairs:', '{{ defect_pairs|tojson|safe }}');
                const parsedPairs = JSON.parse('{{ defect_pairs|tojson|safe }}');
                console.log('Parsed defect pairs:', parsedPairs);
                
                if (parsedPairs && parsedPairs.length > 0) {
                    defectPairs = parsedPairs;
                }
            } catch (error) {
                console.error('Error parsing defect pairs:', error);
                console.error('Raw data was:', '{{ defect_pairs|tojson|safe }}');
                console.log('Using sample data instead');
            }
            
            console.log('Creating defect modal...');
            // Create modal for defect visualization
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                position: relative;
            `;
            
            // Close button
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = `
                position: absolute;
                top: 10px;
                right: 15px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);
            
            // Title
            const title = document.createElement('h2');
            title.textContent = 'Defect Analysis Results';
            title.style.cssText = `
                margin: 0 0 20px 0;
                color: #333;
                text-align: center;
            `;
            
            // Summary
            const summary = document.createElement('div');
            summary.style.cssText = `
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
                text-align: center;
            `;
            summary.innerHTML = `
                <strong>${defectPairs.length} defect relationships detected</strong><br>
                <small>Component-Condition pairs found in reviews</small>
            `;
            
            // Defect pairs visualization
            const defectContainer = document.createElement('div');
            defectContainer.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 15px;
            `;
            
            defectPairs.forEach((pair, index) => {
                const defectCard = document.createElement('div');
                defectCard.style.cssText = `
                    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                    color: white;
                    padding: 20px;
                    border-radius: 12px;
                    text-align: center;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                `;
                
                const component = document.createElement('div');
                component.style.cssText = `
                    font-size: 1.2em;
                    font-weight: bold;
                    margin-bottom: 10px;
                `;
                component.textContent = pair[0];
                
                const arrow = document.createElement('div');
                arrow.style.cssText = `
                    font-size: 1.5em;
                    margin: 10px 0;
                `;
                arrow.textContent = '↓';
                
                const condition = document.createElement('div');
                condition.style.cssText = `
                    font-size: 1.1em;
                    opacity: 0.9;
                `;
                condition.textContent = pair[1];
                
                const defectNumber = document.createElement('div');
                defectNumber.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 15px;
                    background: rgba(255,255,255,0.2);
                    border-radius: 50%;
                    width: 25px;
                    height: 25px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 0.8em;
                    font-weight: bold;
                `;
                defectNumber.textContent = index + 1;
                
                defectCard.appendChild(defectNumber);
                defectCard.appendChild(component);
                defectCard.appendChild(arrow);
                defectCard.appendChild(condition);
                defectContainer.appendChild(defectCard);
            });
            
            // Add defect image if available
            const defectImageUrl = '{{ defect_image_url }}';
            if (defectImageUrl && defectImageUrl !== '/static/None/defects_overlay.png') {
                const imageContainer = document.createElement('div');
                imageContainer.style.cssText = `
                    margin-top: 20px;
                    text-align: center;
                    border-top: 1px solid #eee;
                    padding-top: 20px;
                `;
                
                const imageTitle = document.createElement('h3');
                imageTitle.textContent = 'Defect Visualization';
                imageTitle.style.cssText = `
                    margin: 0 0 15px 0;
                    color: #333;
                `;
                
                const defectImage = document.createElement('img');
                defectImage.src = defectImageUrl;
                defectImage.style.cssText = `
                    max-width: 100%;
                    max-height: 400px;
                    border-radius: 8px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                `;
                
                imageContainer.appendChild(imageTitle);
                imageContainer.appendChild(defectImage);
                modalContent.appendChild(imageContainer);
            }
            
            modalContent.appendChild(closeBtn);
            modalContent.appendChild(title);
            modalContent.appendChild(summary);
            modalContent.appendChild(defectContainer);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            console.log('Defect modal added to DOM');
        }

        // Image modal
        function openImageModal(imageUrl) {
            // Create modal for image viewing
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 10px;
            `;
            
            modal.appendChild(img);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }
        
        // Pagination functionality
        const totalReviews = parseInt('{{ reviews|length }}');
        
        // Initialize pagination
        function initializePagination() {
            updatePagination();
        }
        
        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredReviews.length / reviewsPerPage);
            
            // Update page numbers display
            const pageNumbersContainer = document.getElementById('page-numbers');
            pageNumbersContainer.innerHTML = '';
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbersContainer.appendChild(pageBtn);
            }
            
            // Update pagination info
            const start = filteredReviews.length > 0 ? (currentPage - 1) * reviewsPerPage + 1 : 0;
            const end = Math.min(currentPage * reviewsPerPage, filteredReviews.length);
            document.getElementById('current-page-info').textContent = filteredReviews.length > 0 ? `${start}-${end}` : '0-0';
            
            // Update pagination buttons
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
        }
        
        // Change page
        function changePage(direction) {
            const totalPages = Math.ceil(filteredReviews.length / reviewsPerPage);
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                goToPage(newPage);
            }
        }
        
        // Go to specific page
        function goToPage(page) {
            currentPage = page;
            showCurrentPageReviews();
            updatePagination();
        }
        
        // Show reviews for current page
        function showCurrentPageReviews() {
            // First, hide all review cards
            const allReviewCards = document.querySelectorAll('.review-card');
            allReviewCards.forEach(card => {
                card.style.display = 'none';
            });
            
            // Then show only the filtered reviews for the current page
            const startIndex = (currentPage - 1) * reviewsPerPage;
            const endIndex = startIndex + reviewsPerPage;
            
            filteredReviews.slice(startIndex, endIndex).forEach(card => {
                card.style.display = 'block';
            });
        }
        
        // Initialize pagination when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial display for review cards
            const reviewCards = document.querySelectorAll('.review-card');
            reviewCards.forEach(card => {
                const initialDisplay = card.getAttribute('data-initial-display');
                if (initialDisplay) {
                    card.style.display = initialDisplay;
                }
            });
            
            // Initialize with all reviews and pagination
            filteredReviews = Array.from(reviewCards);
            updateVisibleCount();
            showCurrentPageReviews();
            updatePagination();
        });
        
        // Chatbot functionality
        function toggleChatbot() {
            const modal = document.getElementById('chatbot-modal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
                document.getElementById('chatbot-input').focus();
            }
        }
        
        function handleChatbotKeypress(event) {
            if (event.key === 'Enter') {
                sendChatbotMessage();
            }
        }
        
        function sendChatbotMessage() {
            const input = document.getElementById('chatbot-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';
            
            // Send to backend
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    reviews: JSON.parse('{{ reviews|tojson|safe }}')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.reply === '__chart__') {
                    // Handle chart response
                    addMessage(`Chart: ${data.chart_type}`, 'bot');
                } else {
                    // Handle text response
                    addMessage(data.reply, 'bot');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
            });
        }
        
        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chatbot-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = content.replace(/\n/g, '<br>');
            
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    </script>
</body>
</html> 